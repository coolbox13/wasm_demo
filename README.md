# Zeilen of Motoren — Rust/WASM Sailing Calculator

A sailing calculator that helps you decide how long you can sail before switching to motor to arrive on time. Ported from a [Vue/Vuetify app](https://app.coolbox.com) to Rust/WebAssembly — the entire app is **~75 KB** (down from ~1.6 MB).

**Live:** [app.coolbox.com](https://app.coolbox.com)

## Architecture

The same language (Rust) compiles to `.wasm` for two completely different runtimes:

```
Your Browser                         Spin Server (server-side WASM)
┌─────────────────────┐              ┌─────────────────────────┐
│                     │──GET /──────→│ browser-files component  │
│  index.html loads   │←── HTML ─────│ (serves static files)    │
│                     │              │                          │
│  Browser downloads  │──GET /pkg/──→│ serves .wasm + .js glue  │
│  wasm_browser.wasm  │←── .wasm ────│                          │
│                     │              │                          │
│  ┌───────────────┐  │              │                          │
│  │ Sailing Calc  │  │              │                          │
│  │ (Rust/WASM    │  │              │ ┌──────────────────────┐│
│  │  in browser)  │  │──GET /api──→ │ │ wasm-api component   ││
│  │ calculate()   │  │←── text ──── │ │ handle_request()     ││
│  │ validate()    │  │              │ │                       ││
│  └───────────────┘  │              │ └──────────────────────┘│
└─────────────────────┘              └─────────────────────────┘
   wasm32-unknown-unknown               wasm32-wasip1
   ~47KB .wasm                           ~285KB .wasm
```

- **Browser WASM** runs the sailing calculation logic locally — zero server round-trips
- **Server WASM** (Spin) serves the static files and provides an API endpoint

## Features

- **5 calculation scenarios**: sail only, sail + motor, motor only (on time), motor only (late), and not enough time
- **Settings dialog** (gear icon) with configurable defaults and max values
- **Nautisch / Metrisch toggle** — switch between zeemijl/knopen and km/km/u
- **Fuel consumption** (brandstofverbruik) estimate in liters
- **Next-day dialog** when arrival time is before start time
- **Auto-calculate** on every input change — no submit button needed
- **Material Design-style UI** with floating labels and two-column grid
- **Inline field validation** with max-value enforcement
- **localStorage persistence** — settings remembered across sessions
- **Visual timeline bar** showing sail vs motor proportion
- **Copy-to-clipboard** button on results
- **PWA / offline support** — service worker caches all assets
- **Changeover clock time** — shows when to start the motor

## Size comparison: Vue vs WASM

| | Vue/Vuetify | Rust/WASM |
|---|---:|---:|
| JS bundle | 485 KB | 11 KB |
| CSS | 755 KB | 0 (inline) |
| WASM binary | — | 47 KB |
| HTML | 0.4 KB | 27 KB |
| Icon font | 394 KB | 0 (Google CDN) |
| **Total** | **~1,634 KB** | **~85 KB** |

**19x smaller** with more functionality than the original.

## Project Structure

```
wasm/
├── spin.toml              # Spin manifest (v2) — defines both components
├── Cargo.toml             # Server-side Rust crate (spin-sdk 5.1)
├── src/lib.rs             # Server-side HTTP handler
├── spin_static_fs.wasm    # Pre-built Spin file server component
└── browser/               # Browser-side WASM (the sailing calculator)
    ├── Cargo.toml         # Browser crate (wasm-bindgen)
    ├── src/lib.rs         # Calculation logic in Rust
    ├── index.html         # UI (Material Design-style, inline CSS)
    ├── manifest.json      # PWA web app manifest
    ├── sw.js              # Service worker for offline caching
    ├── .htaccess          # Apache config (WASM MIME, SPA routing)
    └── dist/              # Built output (served by Spin / uploaded to hosting)
        ├── index.html
        ├── manifest.json
        ├── sw.js
        ├── .htaccess
        └── pkg/
            ├── wasm_browser.js       # JS glue (generated by wasm-pack)
            └── wasm_browser_bg.wasm  # WASM binary (~47KB)
```

## Prerequisites

- [Rust](https://rustup.rs/) with targets:
  - `wasm32-wasip1` (server): `rustup target add wasm32-wasip1`
  - `wasm32-unknown-unknown` (browser): added automatically by wasm-pack
- [wasm-pack](https://rustwasm.github.io/wasm-pack/): `cargo install wasm-pack`
- [Spin CLI](https://spinframework.dev/install)

## Build & Run

```bash
# Build browser WASM
cd browser && wasm-pack build --target web --out-dir dist/pkg && cd ..

# Copy static files to dist
cp browser/index.html browser/manifest.json browser/sw.js browser/.htaccess browser/dist/

# Build server WASM + start the server
spin build && spin up
```

Visit [http://127.0.0.1:3000](http://127.0.0.1:3000)

## Deploy to Apache (one.com)

Upload the contents of `browser/dist/` to your web root:

```
/                              ← web root
├── .htaccess                  ← WASM MIME type + SPA routing + HTTPS redirect
├── index.html                 ← the app (27 KB)
├── manifest.json              ← PWA manifest
├── sw.js                      ← service worker
└── pkg/
    ├── wasm_browser.js        ← JS glue (11 KB)
    └── wasm_browser_bg.wasm   ← WASM binary (47 KB)
```

5 files, ~85 KB total. No Node.js, no PHP, no server-side runtime needed.

## Server-side vs Browser-side WASM

| | Server-side (Spin) | Browser-side (wasm-bindgen) |
|---|---|---|
| **Target** | `wasm32-wasip1` | `wasm32-unknown-unknown` |
| **SDK** | `spin-sdk` | `wasm-bindgen` |
| **Runs on** | Spin/Wasmtime on server | Browser's WASM engine |
| **Triggered by** | Incoming HTTP requests | JavaScript function calls |
| **Entry point** | `#[http_component]` macro | `#[wasm_bindgen]` macro |
| **Binary size** | ~285 KB | ~47 KB |
