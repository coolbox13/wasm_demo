<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Browser WASM — Rust in Your Browser</title>
    <style>
        body { font-family: system-ui; max-width: 700px; margin: 40px auto; padding: 0 20px; }
        h1 { color: #333; }
        button { padding: 8px 16px; margin: 4px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; }
        button:hover { background: #f0f0f0; }
        #output { margin-top: 20px; }
        .comparison { background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; font-size: 14px; }
        .comparison code { background: #e0e0e0; padding: 2px 6px; border-radius: 3px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
    </style>
</head>
<body>
    <h1>WASM: Browser vs Server</h1>

    <div class="comparison">
        <strong>What's happening here:</strong><br>
        This HTML page was <em>served</em> by your <code>Spin</code> server (server-side WASM).<br>
        The interactive parts below run <code>Rust → WASM</code> directly in your browser (client-side WASM).<br>
        Same language (Rust), same output format (.wasm), completely different runtimes!
    </div>

    <h2>1. Call Rust from JavaScript</h2>
    <p>Type a name and Rust's <code>greet()</code> function runs in your browser:</p>
    <input type="text" id="name-input" value="Human" placeholder="Enter a name">
    <button onclick="callGreet()">Greet (returns String to JS)</button>
    <button onclick="callAddToPage()">Greet (Rust modifies DOM directly)</button>

    <h2>2. CPU-heavy work in WASM</h2>
    <p>Fibonacci computed by Rust at near-native speed:</p>
    <button onclick="callFib(10)">fib(10)</button>
    <button onclick="callFib(50)">fib(50)</button>
    <button onclick="callFib(90)">fib(90)</button>

    <h2>3. Compare: call the Spin server</h2>
    <p>This calls your <em>server-side</em> WASM via HTTP (same Rust, different runtime):</p>
    <button onclick="callServer()">Fetch from Spin server</button>

    <div id="output"></div>

    <!--
        Loading WASM in the browser requires an async init step.
        wasm-pack generates a JS wrapper ("wasm_browser.js") that handles this.
        The .wasm file is fetched, compiled, and instantiated by the browser engine.
    -->
    <script type="module">
        // Import the JS glue generated by wasm-pack
        import init, { greet, add_greeting_to_page, log_to_console, fibonacci } from './pkg/wasm_browser.js';

        // Initialize the WASM module (downloads + compiles the .wasm file)
        const wasm = await init();

        // Log to browser console to prove WASM is loaded
        log_to_console("WASM module loaded successfully!");

        // Expose functions globally so onclick handlers can call them
        window.callGreet = () => {
            const name = document.getElementById('name-input').value;
            const result = greet(name);  // Rust function called from JS!
            addOutput(`JS received from Rust: "${result}"`);
        };

        window.callAddToPage = () => {
            const name = document.getElementById('name-input').value;
            add_greeting_to_page(name);  // Rust directly modifies the DOM!
        };

        window.callFib = (n) => {
            const start = performance.now();
            const result = fibonacci(n);  // Heavy computation in Rust/WASM
            const ms = (performance.now() - start).toFixed(3);
            addOutput(`fibonacci(${n}) = ${result}  (computed in ${ms}ms by Rust/WASM)`);
        };

        window.callServer = async () => {
            try {
                const resp = await fetch('/api');
                const text = await resp.text();
                addOutput(`Server-side WASM responded: "${text}"`);
            } catch (e) {
                addOutput(`Error calling server: ${e.message}`);
            }
        };

        function addOutput(text) {
            const el = document.createElement('p');
            el.style.cssText = 'font-family: monospace; padding: 8px; background: #e3f2fd; border-radius: 4px; margin: 4px 0; font-size: 14px;';
            el.textContent = text;
            document.getElementById('output').prepend(el);
        }
    </script>
</body>
</html>
